<#
.SYNOPSIS
  Performs system cleanup, disables OneDrive, and configures Windows Update installation strategy.
.DESCRIPTION
  Removes temporary files, initiates driver and feature updates, and disables unnecessary components like OneDrive.
.AUTHOR
  Originally Jessop, enhanced by Robert with Copilot assistance.
.VERSION
  1.0
#>

# =========================
# üßæ Begin Logging
# =========================
$logFile = "C:\Logs\CleanupConfig.log"
Start-Transcript -Path $logFile
Write-Host "üßπ Starting cleanup and update configuration..." -ForegroundColor Cyan

# =========================
# üìÅ Clear Recently Used Files in Quick Access
# =========================
try {
    $Namespace = "shell:::{679f85cb-0220-4080-b29b-5540cc05aab6}"
    $quickAccess = New-Object -ComObject shell.application
    $recentFiles = $quickAccess.Namespace($Namespace).Items()
    $recentFiles | Where-Object { $_.Path -like "*.*" } | ForEach-Object { $_.InvokeVerb("remove") }
    Write-Output "üßº Cleared recent files from Quick Access." | Out-File $logFile -Append
} catch {
    Write-Warning "‚ö†Ô∏è Failed to clear Quick Access files: $_"
}

# =========================
# üóÇÔ∏è Update Initiation with Safety Switches
# =========================
try {
    Set-ExecutionPolicy RemoteSigned -Confirm:$false -Force
    Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Confirm:$false -Force
    Install-Module -Name PSWindowsUpdate -Confirm:$false -Force

    # Set PSGallery as Trusted
    Install-PackageProvider -Name NuGet -Force
    Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
    Install-Module -Name PackageManagement -Force

    # Add Microsoft Update Service
    Add-WUServiceManager -MicrosoftUpdate -Confirm:$false

    # Perform update cycle: skip reboot for first 2 passes
    for ($i = 1; $i -le 2; $i++) {
        Install-WindowsUpdate -Install -AcceptAll -UpdateType Driver `
            -MicrosoftUpdate -ForceDownload -ForceInstall -IgnoreReboot `
            -ErrorAction SilentlyContinue
    }

    # Final pass with reboot enabled
    Install-WindowsUpdate -MicrosoftUpdate -AcceptAll -AutoReboot
    Write-Output "‚¨ÜÔ∏è Windows updates installed and reboot scheduled." | Out-File $logFile -Append
} catch {
    Write-Warning "‚ö†Ô∏è Windows update execution failed: $_"
}

# =========================
# üóÉÔ∏è Disable OneDrive and Remove
# =========================
try {
    Stop-Process -Name "OneDrive" -Force -ErrorAction SilentlyContinue
    $setupPath = "$env:SystemRoot\SysWOW64\OneDriveSetup.exe"
    if (Test-Path $setupPath) {
        Start-Process $setupPath -ArgumentList "/uninstall" -Wait
        Write-Output "üóëÔ∏è OneDrive uninstalled from system." | Out-File $logFile -Append
    } else {
        Write-Warning "‚ö†Ô∏è OneDrive setup not found."
    }
} catch {
    Write-Warning "‚ö†Ô∏è Error during OneDrive removal: $_"
}

# =========================
# ‚úÖ Wrap-Up
# =========================
Stop-Transcript
Write-Host "üßØ Cleanup and update process complete." -ForegroundColor Green